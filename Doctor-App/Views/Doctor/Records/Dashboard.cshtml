@using Newtonsoft.Json
@model Doctor_App.Core.Models.Doctor.DoctorDashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    var serializedVisitStats = JsonConvert.SerializeObject(Model.VisitStats);
}
<h2 class="mb-4">Visits Overview</h2>

<h4>Total Visits: @Model.PatientRecords.Count()</h4>

<div>
    <canvas id="visitsChart" height="100"></canvas>
</div>
<a asp-controller="Doctor" asp-action="Add" class="btn btn-info btn-sm">Add record</a>
<!-- Add this section to show visit counts -->
<div class="mt-4">
    <h5>Daily Visit Summary:</h5>
    <ul class="list-unstyled">
        @foreach (var visit in Model.VisitStats.OrderBy(v => v.Date))
        {
            <li>@visit.Date.ToShortDateString() - <strong>@visit.VisitCount</strong> visits</li>
        }
    </ul>
</div>

<div id="visitList" class="mt-5">
    <!-- Visits for selected date will be injected here -->
</div>

@if (Model.PatientRecords.Any())

{
    <h4 class="mt-5">Patient Records</h4>
    <table class="table table-bordered mt-3">
        <thead class="thead-light">
            <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Visit Date</th>
                <th>Reason</th>
                <th>Diagnosis</th>
                <th>Prescriptions</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var record in Model.PatientRecords)
            {
                <tr>
                    <td>@record.FirstName</td>
                    <td>@record.LastName</td>
                    <td>@record.VisitDate.ToShortDateString()</td>
                    <td>@record.ReasonForVisit</td>
                    <td>@record.Diagnosis</td>
                    <td>@record.Prescriptions</td>
                    <td>@record.Notes</td>
                    <td>
                        <a asp-controller="Doctor" asp-action="View" asp-route-id="@record.Id" class="btn btn-info btn-sm">View</a>
                        <a asp-controller="Doctor" asp-action="Edit" asp-route-id="@record.Id" class="btn btn-warning btn-sm">Edit</a>
                        <a asp-controller="Billing" asp-action="Create" asp-route-visitId="@record.Id" class="btn btn-info btn-sm">Create a billing</a>
                        <form asp-controller="Doctor" asp-action="Delete" asp-route-id="@record.Id" method="post" class="d-inline">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?')">Delete</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<!-- Visit Detail Modal -->
<div class="modal fade" id="visitDetailModal" tabindex="-1" role="dialog" aria-labelledby="visitDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Visit Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>Patient:</strong> <span id="modalPatientName"></span></p>
                <p><strong>Reason for Visit:</strong> <span id="modalReason"></span></p>
                <p><strong>Diagnosis:</strong> <span id="modalDiagnosis"></span></p>
                <p><strong>Prescriptions:</strong> <span id="modalPrescriptions"></span></p>
                <p><strong>Notes:</strong> <span id="modalNotes"></span></p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const chartData = @Html.Raw(serializedVisitStats);

        const ctx = document.getElementById('visitsChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.map(function (d) { return new Date(d.date).toLocaleDateString(); }),
                datasets: [{
                    label: 'Visits per Day',
                    data: chartData.map(function (d) { return d.count; }),
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                onClick: function (evt, item) {
                    if (item.length > 0) {
                        const index = item[0].index;
                        const selectedDate = chartData[index].date;
                        fetch(`/Dashboard/VisitsByDate?date=${selectedDate}`)
                            .then(response => response.text())
                            .then(html => {
                                document.getElementById("visitList").innerHTML = html;
                            });
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        function showDetails(patientName, reason, diagnosis, prescriptions, notes) {
            document.getElementById("modalPatientName").textContent = patientName;
            document.getElementById("modalReason").textContent = reason;
            document.getElementById("modalDiagnosis").textContent = diagnosis;
            document.getElementById("modalPrescriptions").textContent = prescriptions;
            document.getElementById("modalNotes").textContent = notes;
            $('#visitDetailModal').modal('show');
        }
    </script>
}

